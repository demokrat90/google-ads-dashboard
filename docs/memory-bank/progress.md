# Progress

## Фаза 1: Express версия ✅

### Инфраструктура
- [x] Структура проекта Node.js
- [x] package.json с зависимостями
- [x] .env файл настроен
- [x] Сервер Express работает

### Авторизация
- [x] Страница логина `/login`
- [x] Сессии работают
- [x] Логин: admin / admin123

### Страница Google Ads (`/ads`)
- [x] Таблица кампаний и групп
- [x] Расчёт CPL / CPQL
- [x] Текущая неделя (сб-пт)
- [x] История недель
- [x] Webhook для приёма данных

### Страница Застройщики (`/developers`)
- [x] Список застройщиков из MySQL
- [x] Проекты с количеством юнитов
- [x] Сортировка по юнитам DESC
- [x] Фильтр: все / с юнитами
- [x] Модалка выбора избранных
- [x] Колонка "Реклама"

### Интеграции
- [x] MySQL подключён и работает
- [x] amoCRM подключён и работает
- [x] Google Ads Script написан

---

## Фаза 2: Миграция на Next.js + Vercel ✅

### Подготовка (пользователь)
- [x] Создать БД `ads_dashboard` в панели Hostinger
- [x] Создать пользователя MySQL для этой БД
- [x] Выполнить SQL для создания 4 таблиц

### Разработка ✅
- [x] Создать Next.js 16 проект (`ads-dashboard-next/`)
- [x] Установить зависимости (mysql2, next-auth, axios)
- [x] Настроить MySQL подключения (`lib/db-main.ts`, `lib/db-dashboard.ts`)
- [x] Перенести хелперы (`lib/week-helper.ts`, `lib/amocrm.ts`)
- [x] Создать layout и компоненты (`AuthProvider`, `Header`)
- [x] Реализовать /login + NextAuth
- [x] Реализовать /ads
- [x] Реализовать /developers (с модальным окном)
- [x] Создать API webhook (`/api/webhook/google-ads`)
- [x] Создать API favorites (`/api/developers/favorites`)
- [x] Создать API cron endpoints (`sync-amocrm`, `update-history`)
- [x] Настроить `vercel.json`
- [x] Build проходит успешно

### Деплой ✅
- [x] Исправить подключение к ads_dashboard
- [x] Локальное тестирование
- [x] Деплой на Vercel
- [x] Настройка переменных окружения в Vercel
- [x] Обновить Google Ads Script (URL + SECRET)
- [x] Сгенерировать реальные секреты
- [x] Redeploy в Vercel
- [x] Тестирование webhook
- [x] Скопировать google-ads-script.js в Google Ads

### Доработки после деплоя ✅
- [x] Изменить валюту с $ на AED (дирхамы)
- [x] Google Ads Script: сбор данных за неделю (сб-пт) вместо одного дня
- [x] Webhook: принимает weekStart/weekEnd, очищает старые данные
- [x] Исправить формат даты для Google Ads API (YYYYMMDD)
- [x] Исправить дублирование данных (хранить только группы, не кампании)

---

## Фаза 3: Компактная таблица + Лиды по группам ✅

### Компактная таблица (Январь 2026)
- [x] Создать клиентский компонент `AdsTable.tsx`
- [x] Переключатель "Все / Только кампании"
- [x] Кнопки "Развернуть все / Свернуть все"
- [x] Сворачивание/разворачивание кампаний (▼/▶)
- [x] Кампания и первая группа в одной строке
- [x] Остальные группы под первой (вертикально)

### Лиды по группам объявлений (Январь 2026)
- [x] Извлечение campaign_id из utm_campaign (`cid|ID|search`)
- [x] Извлечение adgroup_id из utm_content (`gid|ID|aid|...`)
- [x] Добавить поля campaign_id, adgroup_id в amocrm_leads
- [x] Обновить getLeadsForWeek для группировки по adgroup_id
- [x] Маппинг лидов на группы объявлений в page.tsx
- [x] Отображение лидов групп в AdsTable.tsx

### Синхронизация amoCRM
- [x] Изменить cron с раз в день на ежечасно
- [x] Создать таблицу tilda_leads для Tilda без UTM

---

## Фаза 4: Будущие улучшения

- [ ] Сопоставление кампаний Google Ads с застройщиками/проектами
- [ ] Авторизация через Telegram
- [ ] Проверить статусы юнитов (available/for_sale)
- [ ] Добавить обновление данных по кнопке
- [ ] Мобильная адаптация

---

## Текущий статус

**✅ Компактная таблица с лидами по группам готова!**

- URL: https://ads-dashboard-next.vercel.app
- Логин: admin / admin123
- Валюта: AED (дирхамы)
- Синхронизация amoCRM: ежечасно
- Таблица: два режима "Все" и "Только кампании"

---

## Известные проблемы

| Проблема | Решение |
|----------|---------|
| Порт 3000 зависает (Windows) | `npx kill-port 3000` |
| better-sqlite3 не работает на Windows | Заменён на sql.js |
| Developer Token Google Ads | Используем Scripts (без токена) |
| SQLite не работает на Vercel | Миграция на MySQL |
| Next.js 16 middleware deprecation | Warning, не критично |
| Google Ads API требует формат YYYYMMDD | Используем два формата в скрипте |

---

## Документация

| Файл | Описание |
|------|----------|
| `CLAUDE.md` | Главная документация проекта |
| `docs/MIGRATION_NEXTJS_VERCEL.md` | Полный план миграции с кодом |
| `docs/memory-bank/*.md` | Контекст проекта |
